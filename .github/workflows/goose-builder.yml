name: "ðŸª¿ Goose CRM Builder"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Runs every 30 minutes by default.
# Change the cron or CYCLE_INTERVAL to adjust.
# Can also be triggered manually from GitHub UI.
# Concurrency: only one run at a time to avoid conflicts.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

concurrency:
  group: goose-crm-${{ github.repository }}
  cancel-in-progress: false

on:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes
  workflow_dispatch:
    inputs:
      task_override:
        description: "Optional: override the agent task (leave blank for auto)"
        required: false
        default: ""
      force_merge:
        description: "Force merge dev â†’ main after this run"
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: write

env:
  # â”€â”€ Novita / Goose â”€â”€
  GOOSE_PROVIDER: openai
  GOOSE_MODEL: deepseek/deepseek-v3.2
  GOOSE_MODE: auto
  OPENAI_API_KEY: ${{ secrets.NOVITA_API_KEY }}
  OPENAI_HOST: https://api.novita.ai
  OPENAI_BASE_PATH: openai/v1/chat/completions

  # â”€â”€ Deployment (Goose can view the live site to verify changes) â”€â”€
  CRM_DEPLOYMENT_URL: https://the-bodega-crm.vercel.app

  # â”€â”€ Goose run limit â€” 60 min so job has time for build/lint/commit (job timeout 90 min) â”€â”€
  GOOSE_TIMEOUT_MINUTES: 60

  # â”€â”€ Supabase (Goose reads these to wire up the backend) â”€â”€
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

  # â”€â”€ Git identity â”€â”€
  GIT_AUTHOR_NAME: "Goose Agent"
  GIT_AUTHOR_EMAIL: "goose@automated.dev"
  GIT_COMMITTER_NAME: "Goose Agent"
  GIT_COMMITTER_EMAIL: "goose@automated.dev"

jobs:
  build-crm:
    runs-on: ubuntu-latest
    timeout-minutes: 90 # give Goose enough time for complex tasks (deal pipeline, etc.)

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout the repo
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history so we can branch/merge
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Setup Node (needed for Goose + the CRM project)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Install project dependencies (required for build verification)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: npm ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Install Goose CLI
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Goose
        run: |
          curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh | CONFIGURE=false bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Install GitHub CLI (for PRs)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify gh CLI
        run: gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Setup git and branches
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup branches
        run: |
          git config user.name "Goose Agent"
          git config user.email "goose@automated.dev"

          # Ensure dev branch exists
          if git ls-remote --heads origin dev | grep -q dev; then
            git checkout dev
            git pull origin dev
          else
            git checkout -b dev
            git push -u origin dev
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Determine next task
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Determine task
        id: task
        run: |
          OVERRIDE="${{ github.event.inputs.task_override || '' }}"
          if [ -n "$OVERRIDE" ]; then
            echo "task=$OVERRIDE" >> $GITHUB_OUTPUT
            echo "Using manual override task."
          else
            echo "task=auto" >> $GITHUB_OUTPUT
            echo "Agent will auto-select from ROADMAP.md"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Run Goose agent
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Goose builder agent
        run: |
          chmod +x agent/run-cycle.sh
          bash agent/run-cycle.sh "${{ steps.task.outputs.task }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Verify build and lint (quality gate â€” fail before committing)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify build
        id: verify-build
        run: npm run build

      - name: Verify lint
        id: verify-lint
        run: npm run lint

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Commit changes to dev
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit to dev
        id: commit
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit."
          else
            SUMMARY=$(cat /tmp/goose-summary.txt 2>/dev/null || echo "Automated CRM improvement")
            git commit -m "ðŸª¿ goose: ${SUMMARY}" \
              -m "Model: deepseek/deepseek-v3.2 via Novita AI" \
              -m "Automated build cycle at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push origin dev
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 10. Check if milestone reached â†’ merge to main
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Evaluate merge to main
        if: steps.commit.outputs.changes == 'true'
        run: |
          SHOULD_MERGE="false"

          # Force merge if manually requested
          if [ "${{ github.event.inputs.force_merge }}" = "true" ]; then
            SHOULD_MERGE="true"
            echo "Force merge requested."
          fi

          # Check if Goose flagged this as a milestone
          if [ -f /tmp/goose-milestone.flag ]; then
            SHOULD_MERGE="true"
            echo "Milestone reached â€” merging to main."
          fi

          if [ "$SHOULD_MERGE" = "true" ]; then
            git checkout main
            git pull origin main
            git merge dev --no-ff -m "ðŸš€ Merge milestone from dev â€” $(cat /tmp/goose-summary.txt 2>/dev/null || echo 'CRM update')"
            git push origin main
            echo "âœ… Merged dev â†’ main. Vercel will auto-deploy."
          else
            echo "No milestone yet. Changes stay on dev."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 11. Upload Goose log (for debugging failed runs)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload Goose log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: goose-output-${{ github.run_id }}
          path: /tmp/goose-output.log
          retention-days: 7
          if-no-files-found: ignore

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 12. Post run summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post summary
        if: always()
        run: |
          echo "## ðŸª¿ Goose Build Cycle Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** deepseek/deepseek-v3.2 via Novita AI" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Live site:** [the-bodega-crm.vercel.app](https://the-bodega-crm.vercel.app)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/goose-summary.txt ]; then
            echo "### What was done:" >> $GITHUB_STEP_SUMMARY
            cat /tmp/goose-summary.txt >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f /tmp/goose-milestone.flag ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ MILESTONE â€” Merged to main, Vercel deploying" >> $GITHUB_STEP_SUMMARY
          fi
