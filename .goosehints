# TheBodegaCRM — Goose Project Hints

## Project Overview
You are building TheBodegaCRM — a modern, full-featured CRM application.

**Live deployment:** https://the-bodega-crm.vercel.app — You can view the deployed site to verify changes, check UI/UX, or debug issues.

## Tech Stack
- **Framework:** Next.js 14 (App Router, Server Components)
- **Language:** TypeScript (strict mode)
- **Styling:** Tailwind CSS (utility classes only, no custom CSS files)
- **Backend:** Supabase (Postgres database, Auth, Row Level Security)
- **State Management:** Zustand (client state), React Query / TanStack Query (server state)
- **Forms:** react-hook-form + zod validation
- **Icons:** lucide-react
- **Date handling:** date-fns

## Architecture Rules

### File Structure
```
src/
  app/                    # Next.js App Router pages
    (auth)/               # Auth routes (login, signup) — no layout protection
    (dashboard)/          # Protected routes — layout checks auth
  components/             # Reusable UI components
    ui/                   # Base UI components (button, input, card, modal, etc.)
    layout/               # Sidebar, header, etc.
    contacts/             # Contact-specific components
    companies/            # Company-specific components
    deals/                # Deal-specific components
    activities/           # Activity-specific components
    dashboard/            # Dashboard widgets
    search/               # Global search
  lib/
    supabase/             # Supabase client setup (client.ts, server.ts, middleware.ts)
    api/                  # Data fetching/mutation functions (contacts.ts, companies.ts, etc.)
    auth/                 # Auth server actions
    utils.ts              # Shared utility functions
  hooks/                  # Custom React hooks (use-contacts.ts, use-companies.ts, etc.)
  types/                  # TypeScript type definitions
    database.ts           # Supabase table types
supabase/
  migrations/             # SQL migration files (001_contacts.sql, etc.)
```

### Coding Conventions
- Use `"use client"` directive ONLY when the component needs interactivity (state, effects, event handlers)
- Default to Server Components when possible
- Never use `any` type — always define proper types
- Use named exports for components, default exports only for pages
- All API functions should be in `src/lib/api/` and accept typed parameters
- All forms use react-hook-form with zod schemas
- React Query hooks go in `src/hooks/` and handle cache invalidation
- Error handling: wrap Supabase calls in try/catch, return `{ data, error }` pattern

### Supabase
- Client-side: use the client from `src/lib/supabase/client.ts`
- Server-side: use the client from `src/lib/supabase/server.ts`
- Environment variables are set:
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`

### Multi-Tenancy — ALL DATA IS ORG-SCOPED
- The app uses **organization-based multi-tenancy** (see `008_organizations.sql`).
- Every data table has an `org_id` column. Data is shared between org members, NOT isolated per user.
- **RLS policies MUST use org-based access**, not `user_id = auth.uid()`. Use this pattern:
  ```sql
  CREATE POLICY "Org members can view" ON my_table
    FOR SELECT USING (org_id IN (SELECT public.get_user_org_ids()));
  ```
- **NEVER write RLS policies that only check `user_id = auth.uid()`.** That breaks multi-tenancy — other org members won't see shared data.
- The helper function `public.get_user_org_ids()` returns all org IDs the current user belongs to. Use it in all RLS policies.
- All API files (`src/lib/api/*.ts`) use `getActiveOrgId()` from `src/lib/api/organizations.ts` and filter by `.eq('org_id', orgId!)`.
- When creating new API files, follow the pattern in `src/lib/api/contacts.ts` — fetch `orgId`, early return if missing, filter all queries by `org_id`.

### SQL Migrations — CRITICAL RULES
- **NEVER insert seed/sample data with hardcoded UUIDs.** Foreign keys reference `auth.users`, and fake UUIDs like `'00000000-0000-0000-0000-000000000000'` will violate FK constraints. Seed data should be created through the application layer, not in migrations.
- Migrations should ONLY contain: CREATE TABLE, ALTER TABLE, CREATE INDEX, CREATE POLICY, CREATE FUNCTION, CREATE TRIGGER statements.
- If you need default/template data, create an API endpoint or app-level seeder function — not SQL INSERT statements in migrations.
- **Check existing migration numbers** before creating a new one. Run `ls supabase/migrations/` and use the next available number. Do NOT reuse or duplicate a number.
- All new tables MUST include `org_id UUID REFERENCES organizations(id) ON DELETE CASCADE` and org-based RLS policies.

### UI / Design
- Clean, modern, professional look
- Color scheme: slate grays + indigo-600 as primary accent
- Sidebar: dark (slate-900), fixed left, 260px wide
- Content area: light (slate-50 background)
- Cards: white background, subtle shadow, rounded-lg
- Tables: clean with hover states on rows
- Forms: clear labels, validation error messages in red-500 below fields
- Buttons: primary (indigo-600), secondary (slate border), danger (red-600)
- All pages must be responsive (mobile-friendly)

### Build Verification — THE #1 RULE
- Run `npm run build` and `npm run lint` **AFTER EACH TASK** — not just at the end of the cycle
- If you complete 3 tasks and only build at the end, one broken import can lose all your work
- Never import or reference a module/file you haven't created yet — create it first, then import
- Fix ALL TypeScript and ESLint errors in files you touch (including pre-existing lint errors)
- If build or lint fails, read the errors, fix them, and run again — do not move on until both pass

### Dependency Safety — CRITICAL
- **NEVER import a package that isn't in `package.json`.** Before using any new npm package, run `npm install <package>` first.
- Before adding a new shadcn/radix component, check if the underlying `@radix-ui/*` package is already installed. If not, install it.
- After adding any new import from a third-party package, immediately verify it exists: `grep <package-name> package.json`. If it's missing, install it.
- Common mistake to avoid: adding a UI component file (e.g. `dropdown-menu.tsx`) that imports `@radix-ui/react-dropdown-menu` without running `npm install @radix-ui/react-dropdown-menu`.

### Provider / Context Safety — CRITICAL
- If you add hooks that require a React context provider (e.g. `useQuery` requires `QueryClientProvider`, `useTheme` requires `ThemeProvider`), you MUST verify the provider exists in the component tree.
- The app's provider stack lives in `src/components/providers.tsx` and is used in `src/app/layout.tsx`. If you need a new provider, add it there — do NOT assume it exists.
- **React Query**: All `useQuery` / `useMutation` hooks require `QueryClientProvider`. It's already set up in `src/components/providers.tsx`. Do NOT create a second one.
- If you create a new context, add its provider to `src/components/providers.tsx`.

### Recovery from [build-broken] Commits
- If the last commit message contains `[build-broken]`, your FIRST priority is to run `npm run build`, read the errors, and fix them before doing any new work
- Check `git log -1 --oneline` at the start — if you see `[build-broken]`, fix the build first

### Code Patterns
- Follow existing patterns: look at how similar features were built (e.g. contacts module) and replicate that structure for companies, deals, activities
- **Investors module** follows the same pattern as contacts/companies: list page → new page → detail page → edit page, with `src/lib/api/investors.ts` for data and `src/hooks/use-investors.ts` for React Query hooks
- **AI features** use the Novita API via `src/lib/api/ai.ts` — always parse JSON responses with fallback handling
- **Gmail integration** uses OAuth tokens stored in `email_accounts` table — always refresh tokens before API calls using `refreshAccessToken()`
- **LTV/CAC** metrics are computed from deals (closed_won = revenue) and `acquisition_costs` table

### New Modules Added (Phase 9-13)
- `src/lib/api/investors.ts` — investor + investment CRUD and stats
- `src/lib/api/ai.ts` — Novita AI wrapper (summarizeEmail, generateFollowUp, suggestDealStage, analyzeLtvCac)
- `src/lib/api/gmail.ts` — Gmail OAuth + metadata fetching
- `src/app/(dashboard)/investors/` — investor management pages
- `src/app/(dashboard)/email/` — email AI hub
- `src/app/api/gmail/` — Gmail OAuth routes (connect + callback)
- `supabase/migrations/006_investors.sql` — investors + investments tables
- `supabase/migrations/007_email_and_ai.sql` — email_accounts + email_summaries + acquisition_costs tables

### Environment Variables (new)
- `NOVITA_API_KEY` — API key for Novita AI (used for email summarization, follow-up generation, deal suggestions)
- `GOOGLE_CLIENT_ID` — Google OAuth client ID for Gmail
- `GOOGLE_CLIENT_SECRET` — Google OAuth client secret
- `GOOGLE_REDIRECT_URI` — OAuth redirect (e.g. https://the-bodega-crm.vercel.app/api/gmail/callback)

### Git Behavior
- You are working on the `dev` branch
- The workflow handles committing and pushing — just make your code changes
- Do NOT run git commands yourself

### Milestone Rules
Write "MILESTONE" to `/tmp/goose-milestone.flag` when:
- An entire Phase in ROADMAP.md is completed
- The app first compiles and builds successfully
- A major user-facing feature is fully working (auth, contacts CRUD, deals pipeline)

Always write a 1-2 line summary to `/tmp/goose-summary.txt`.
